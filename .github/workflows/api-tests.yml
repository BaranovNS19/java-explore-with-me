name: Explore With Me API Tests

on:
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Copy checkstyle config
        run: |
          cp -rf ./tests/checkstyle.xml ./checkstyle.xml
          cp -rf ./tests/suppressions.xml ./suppressions.xml

      - name: Build with Maven
        run: mvn clean install -P check --no-transfer-progress

      - name: Verify JAR files
        run: |
          echo "=== Checking built JAR files ==="
          ls -la statistic/target/*.jar || echo "No statistic JAR found"
          ls -la product/target/*.jar || echo "No product JAR found"
          java -jar statistic/target/statistic-0.0.1-SNAPSHOT.jar --version || echo "Statistic JAR check completed"
          java -jar product/target/product-0.0.1-SNAPSHOT.jar --version || echo "Product JAR check completed"

      - name: Build Docker images
        run: docker compose build

      - name: Start services and show logs in real-time
        run: |
          # Запускаем в фоне
          docker compose up --detach
          
          # Даем время на запуск и сразу смотрим логи
          echo "=== Waiting 15 seconds for initial startup ==="
          sleep 15
          
          echo "=== Current container status ==="
          docker compose ps
          
          echo "=== Stats server logs (last 50 lines) ==="
          docker compose logs --tail=50 stats-server
          
          echo "=== EWM service logs (last 50 lines) ==="
          docker compose logs --tail=50 ewm-service

      - name: Wait for services with detailed debugging
        run: |
          echo "=== Starting detailed service check ==="
          
          # Проверяем процессы в контейнерах
          echo "=== Checking processes in containers ==="
          docker compose exec stats-server ps aux || echo "Cannot exec into stats-server - container may not be running"
          docker compose exec ewm-service ps aux || echo "Cannot exec into ewm-service - container may not be running"
          
          # Проверяем логи еще раз
          echo "=== Current logs ==="
          docker compose logs stats-server
          docker compose logs ewm-service

      - name: Simple port check
        run: |
          echo "=== Simple port availability check ==="
          
          # Проверяем порт 9090 (stats-server)
          echo "Checking port 9090 (stats-server)..."
          if timeout 30 bash -c 'until nc -z localhost 9090; do echo "Waiting for port 9090..."; sleep 2; done'; then
            echo "✓ Port 9090 is available"
          else
            echo "✗ Port 9090 check failed"
            echo "=== Stats server logs ==="
            docker compose logs stats-server
            exit 1
          fi
          
          # Проверяем порт 8080 (ewm-service)
          echo "Checking port 8080 (ewm-service)..."
          if timeout 30 bash -c 'until nc -z localhost 8080; do echo "Waiting for port 8080..."; sleep 2; done'; then
            echo "✓ Port 8080 is available"
          else
            echo "✗ Port 8080 check failed"
            echo "=== EWM service logs ==="
            docker compose logs ewm-service
            exit 1
          fi

      - name: Run API tests
        run: |
          echo "=== Both services are up, would run tests here ==="
          # Здесь будут запускаться тесты, когда сервисы работают
          echo "Services are ready for testing"

      - name: Final logs on failure
        if: failure()
        run: |
          echo "=== FINAL LOGS ON FAILURE ==="
          echo "=== Stats server full logs ==="
          docker compose logs stats-server || true
          echo "=== EWM service full logs ==="
          docker compose logs ewm-service || true
          echo "=== Database logs ==="
          docker compose logs ewm-db || true
          docker compose logs stats-db || true

      - name: Stop services
        if: always()
        run: docker compose down